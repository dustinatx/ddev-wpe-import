#!/bin/bash

## CanRunGlobally: true
## Description: Import WP Engine backups into new DDEV WordPress projects

# =============================================================================
# ddev wpe-import - Import WP Engine backups into DDEV WordPress projects
# =============================================================================

# Exit on error, but we'll handle errors explicitly where needed
set -e

# =============================================================================
# Color Output
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

print_info() {
    echo -e "${BLUE}$1${NC}"
}

# =============================================================================
# Blacklist and Whitelist Arrays
# =============================================================================
BLACKLIST=(
    # WPE-specific
    "WPE_APIKEY" "PWP_NAME" "WPE_CLUSTER_ID" "WPE_CLUSTER_TYPE" "IS_WPE" "IS_WPE_SNAPSHOT"
    "WPE_ISP" "WPE_BPOD" "WPE_RO_FILESYSTEM" "WPE_LARGEFS_BUCKET" "WPE_SFTP_PORT"
    "WPE_SFTP_ENDPOINT" "WPE_LBMASTER_IP" "WPE_CDN_DISABLE_ALLOWED" "WPE_FORCE_SSL_LOGIN"
    "WPE_EXTERNAL_URL" "WPE_WHITELABEL" "WPE_BETA_TESTER" "PWP_ROOT_DIR"
    # Security keys/salts
    "AUTH_KEY" "SECURE_AUTH_KEY" "LOGGED_IN_KEY" "NONCE_KEY"
    "AUTH_SALT" "SECURE_AUTH_SALT" "LOGGED_IN_SALT" "NONCE_SALT"
    # Database connection
    "DB_NAME" "DB_USER" "DB_PASSWORD" "DB_HOST" "DB_HOST_SLAVE" "DB_CHARSET" "DB_COLLATE"
    # Caching
    "WP_CACHE"
    # Filesystem
    "FS_METHOD" "FS_CHMOD_DIR" "FS_CHMOD_FILE"
    # WPE/hosting defaults
    "FORCE_SSL_LOGIN" "WP_TURN_OFF_ADMIN_BAR" "DISABLE_WP_CRON" "ALTERNATE_WP_CRON" "WP_CRON_LOCK_TIMEOUT"
    # Deprecated
    "WPLANG"
    # We set these ourselves
    "DISABLE_2FA_LOGIN" "WP_DEBUG" "WP_DEBUG_LOG" "WP_DEBUG_DISPLAY"
    "AUTOMATIC_UPDATER_DISABLED" "WP_AUTO_UPDATE_CORE" "WP_ENVIRONMENT_TYPE"
    # WordPress core (we define these ourselves)
    "ABSPATH"
)

WHITELIST=(
    # Debug flags
    "SCRIPT_DEBUG" "SAVEQUERIES"
    # Performance
    "WP_POST_REVISIONS" "AUTOSAVE_INTERVAL" "WP_MEMORY_LIMIT" "WP_MAX_MEMORY_LIMIT" "EMPTY_TRASH_DAYS"
    # Core settings
    "DISALLOW_FILE_EDIT" "DISALLOW_FILE_MODS"
    # Security (special handling for WP2FA_ENCRYPT_KEY)
    "WP2FA_ENCRYPT_KEY"
)

# =============================================================================
# Helper Functions
# =============================================================================

convert_windows_path() {
    local path="$1"
    # Check if Windows path (starts with drive letter)
    if [[ "$path" =~ ^[A-Za-z]: ]]; then
        # Convert C:\ to /mnt/c/
        path=$(echo "$path" | sed 's|\\|/|g' | sed 's|^\([A-Za-z]\):|/mnt/\L\1|')
    fi
    echo "$path"
}

expand_path() {
    local path="$1"
    # Expand ~ to home directory
    path="${path/#\~/$HOME}"
    # Convert to absolute path if relative
    if [[ ! "$path" = /* ]]; then
        path="$(pwd)/$path"
    fi
    echo "$path"
}

sanitize_project_name() {
    local name="$1"
    # Lowercase, replace special chars with hyphens, remove consecutive hyphens, trim hyphens
    name=$(echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
    echo "$name"
}

is_in_array() {
    local needle="$1"
    shift
    local haystack=("$@")
    for item in "${haystack[@]}"; do
        [[ "$item" == "$needle" ]] && return 0
    done
    return 1
}

# =============================================================================
# Phase 1: Input Collection & Validation
# =============================================================================

check_prerequisites() {
    print_info "Checking prerequisites..."

    if ! command -v unzip &> /dev/null; then
        print_error "unzip command not found. Please install unzip."
        exit 1
    fi

    if ! command -v curl &> /dev/null; then
        print_error "curl command not found. Please install curl."
        exit 1
    fi

    print_success "Prerequisites OK"
}

get_backup_path() {
    local path
    while true; do
        echo ""
        read -r -p "Enter path to WP Engine backup zip file: " path

        # Strip surrounding quotes if present
        path="${path#\"}"
        path="${path%\"}"
        path="${path#\'}"
        path="${path%\'}"

        # Convert Windows path if needed
        path=$(convert_windows_path "$path")

        # Expand ~ and make absolute
        path=$(expand_path "$path")

        # Validate file exists
        if [[ ! -f "$path" ]]; then
            print_error "File not found: $path"
            continue
        fi

        # Validate it's a zip file
        if [[ ! "$path" =~ \.zip$ ]]; then
            print_error "File must be a .zip file"
            continue
        fi

        BACKUP_PATH="$path"
        break
    done
}

get_project_directory() {
    local current_dir=$(pwd)
    local target_dir

    echo ""
    echo "Current directory: $current_dir"
    read -r -p "Create project here? (y/n): " use_current

    if [[ "$use_current" =~ ^[Yy] ]]; then
        target_dir="$current_dir"
    else
        read -r -p "Enter target directory path: " target_dir
        target_dir=$(expand_path "$target_dir")
    fi

    # Check if it's already a DDEV project
    if [[ -f "$target_dir/.ddev/config.yaml" ]]; then
        print_error "This directory already contains a DDEV project"
        exit 1
    fi

    # Check if directory exists and is not empty
    if [[ -d "$target_dir" ]] && [[ -n "$(ls -A "$target_dir" 2>/dev/null)" ]]; then
        print_warning "Directory exists and is not empty: $target_dir"
        read -r -p "Use this directory anyway? (y/n): " use_anyway
        if [[ ! "$use_anyway" =~ ^[Yy] ]]; then
            print_error "Aborted by user"
            exit 1
        fi
    fi

    PROJECT_DIR="$target_dir"
}

get_project_name() {
    local name
    local sanitized

    while true; do
        echo ""
        read -r -p "Enter project name: " name

        # Sanitize the name
        sanitized=$(sanitize_project_name "$name")

        if [[ -z "$sanitized" ]]; then
            print_error "Invalid project name"
            continue
        fi

        if [[ "$sanitized" != "$name" ]]; then
            print_info "Project name sanitized to: $sanitized"
        fi

        # Check if DDEV project with this name already exists
        if ddev list 2>/dev/null | grep -q "^$sanitized "; then
            print_error "A DDEV project named '$sanitized' already exists"
            continue
        fi

        PROJECT_NAME="$sanitized"
        break
    done
}

get_admin_options() {
    echo ""
    read -r -p "Create a new admin account? (username: admin, password: password) (y/n): " create_admin

    if [[ "$create_admin" =~ ^[Yy] ]]; then
        CREATE_DEFAULT_ADMIN=true
        RESET_PASSWORD=false
    else
        CREATE_DEFAULT_ADMIN=false
        echo ""
        read -r -p "Do you want to reset an existing admin user's password after import? (y/n): " reset_pass

        if [[ "$reset_pass" =~ ^[Yy] ]]; then
            RESET_PASSWORD=true
        else
            RESET_PASSWORD=false
        fi
    fi
}

show_confirmation() {
    local ddev_url="https://${PROJECT_NAME}.ddev.site"

    echo ""
    echo "============================================"
    echo "Summary:"
    echo "============================================"
    echo "  Backup: $BACKUP_PATH"
    echo "  Project Directory: $PROJECT_DIR"
    echo "  Project Name: $PROJECT_NAME"
    echo "  DDEV URL: $ddev_url"
    if [[ "$CREATE_DEFAULT_ADMIN" = true ]]; then
        echo "  Create Admin Account: Yes (admin:password)"
    elif [[ "$RESET_PASSWORD" = true ]]; then
        echo "  Reset Admin Password: Yes"
    else
        echo "  Admin Account Changes: None"
    fi
    echo "============================================"
    echo ""

    read -r -p "Proceed? (y/n): " proceed

    if [[ ! "$proceed" =~ ^[Yy] ]]; then
        print_info "Aborted by user"
        exit 0
    fi
}

# =============================================================================
# Phase 2: Project Setup
# =============================================================================

prepare_directory() {
    print_info "Preparing project directory..."

    mkdir -p "$PROJECT_DIR"
    cd "$PROJECT_DIR"

    print_success "Directory ready: $PROJECT_DIR"
}

extract_backup() {
    print_info "Extracting backup..."

    local zip_name=$(basename "$BACKUP_PATH")
    local zip_in_project="$PROJECT_DIR/$zip_name"
    local copied_zip=false

    # Copy zip if not already in project directory
    if [[ "$BACKUP_PATH" != "$zip_in_project" ]]; then
        cp "$BACKUP_PATH" "$zip_in_project"
        copied_zip=true
    fi

    # Extract
    if ! unzip -q "$zip_in_project"; then
        print_error "Failed to extract backup"
        exit 1
    fi

    # Delete the copy (not the original)
    if [[ "$copied_zip" = true ]]; then
        rm "$zip_in_project"
    fi

    # Verify required files exist
    if [[ ! -f "wp-config.php" ]]; then
        print_error "wp-config.php not found in backup"
        exit 1
    fi

    if [[ ! -f "wp-content/mysql.sql" ]]; then
        print_error "Database file not found at wp-content/mysql.sql"
        exit 1
    fi

    print_success "Backup extracted successfully"
}

cleanup_wpe_files() {
    print_info "Cleaning up WP Engine files..."

    # Remove .ddev folder if it exists in backup (would conflict with new config)
    rm -rf .ddev 2>/dev/null || true

    # Files and directories to remove
    local wpe_files=(
        "wp-content/advanced-cache.php"
        "wp-content/object-cache.php"
        "wp-content/mu-plugins/force-strong-passwords"
        "wp-content/mu-plugins/wpe-cache-plugin"
        "wp-content/mu-plugins/wpe-update-source-selector"
        "wp-content/mu-plugins/wpe-wp-sign-on-plugin"
        "wp-content/mu-plugins/wpengine-common"
        "wp-content/mu-plugins/mu-plugin.php"
        "wp-content/mu-plugins/slt-force-strong-passwords.php"
        "wp-content/mu-plugins/stop-long-comments.php"
        "wp-content/mu-plugins/wpe-cache-plugin.php"
        "wp-content/mu-plugins/wpe-update-source-selector.php"
        "wp-content/mu-plugins/wpe-wp-sign-on-plugin.php"
        "wp-content/mu-plugins/wpengine-security-auditor.php"
    )

    for file in "${wpe_files[@]}"; do
        rm -rf "$file" 2>/dev/null || true
    done

    print_success "WP Engine files cleaned up"
}

analyze_wp_config() {
    print_info "Analyzing wp-config.php..."

    # Rename original wp-config.php
    mv wp-config.php wp-config-backup.php

    # Extract table prefix
    TABLE_PREFIX=$(grep -E "^\s*\\\$table_prefix\s*=" wp-config-backup.php | sed -E "s/.*=\s*['\"]([^'\"]+)['\"].*/\1/" | head -1)

    if [[ -z "$TABLE_PREFIX" ]]; then
        print_error "Could not extract table prefix from wp-config.php"
        exit 1
    fi

    print_info "Table prefix: $TABLE_PREFIX"

    # Extract and process constants
    CONSTANTS_TO_PRESERVE=()
    UNKNOWN_CONSTANTS=()
    HAS_WP2FA_KEY=false
    WP2FA_LINE=""

    # Read define statements
    while IFS= read -r line; do
        # Skip empty lines
        [[ -z "$line" ]] && continue

        # Extract constant name
        local const_name=$(echo "$line" | sed -E "s/.*define\s*\(\s*['\"]([^'\"]+)['\"].*/\1/")

        # Skip if we couldn't extract the name
        [[ -z "$const_name" ]] && continue

        # Check blacklist - skip if found
        if is_in_array "$const_name" "${BLACKLIST[@]}"; then
            continue
        fi

        # Handle WP2FA_ENCRYPT_KEY separately (special placement in wp-config.php)
        if [[ "$const_name" == "WP2FA_ENCRYPT_KEY" ]]; then
            HAS_WP2FA_KEY=true
            WP2FA_LINE="$line"
            continue
        fi

        # Check whitelist - preserve if found
        if is_in_array "$const_name" "${WHITELIST[@]}"; then
            CONSTANTS_TO_PRESERVE+=("$line")
            continue
        fi

        # Unknown constant - auto-preserve and track for warning
        CONSTANTS_TO_PRESERVE+=("$line")
        UNKNOWN_CONSTANTS+=("$const_name")

    done < <(grep -E "^\s*define\s*\(" wp-config-backup.php)

    print_success "wp-config.php analyzed"
}

configure_ddev() {
    print_info "Configuring DDEV..."

    if ! ddev config --project-type=wordpress --project-name="$PROJECT_NAME"; then
        print_error "DDEV configuration failed"
        exit 1
    fi

    print_success "DDEV configured"
}

create_wp_config() {
    print_info "Creating custom wp-config.php..."

    # Fetch fresh authentication keys and salts from WordPress API
    print_info "Fetching authentication keys from WordPress.org..."
    local auth_keys
    auth_keys=$(curl -s https://api.wordpress.org/secret-key/1.1/salt/)

    if [[ -z "$auth_keys" ]] || [[ ! "$auth_keys" =~ AUTH_KEY ]]; then
        print_error "Failed to fetch authentication keys from WordPress.org"
        exit 1
    fi

    # Build WP2FA section if WP2FA_ENCRYPT_KEY was found
    local wp2fa_section=""
    if [[ "$HAS_WP2FA_KEY" = true ]]; then
        wp2fa_section="
/** WP 2FA plugin data encryption key. For more information please visit melapress.com */
${WP2FA_LINE}
define( 'DISABLE_2FA_LOGIN', true );
"
    fi

    # Build preserved constants section
    local preserved_constants=""
    if [[ ${#CONSTANTS_TO_PRESERVE[@]} -gt 0 ]]; then
        preserved_constants="// ======================
// Preserved Constants (from original wp-config.php)
// ======================
"
        for const in "${CONSTANTS_TO_PRESERVE[@]}"; do
            preserved_constants+="$const
"
        done
        preserved_constants+="
"
    fi

    # Write the new wp-config.php
    cat > wp-config.php << WPCONFIG
<?php
/**
 * wp-config.php for imported WPE site
 * This file is user-managed (not DDEV-generated)
 */${wp2fa_section}

/** Database charset to use in creating database tables. */
define( 'DB_CHARSET', 'utf8' );

/** The database collate type. Don't change this if in doubt. */
define( 'DB_COLLATE', 'utf8_unicode_ci' );

// ======================
// Local Development Defaults
// ======================
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);
@ini_set('display_errors', 0);
define('AUTOMATIC_UPDATER_DISABLED', true);
define('WP_ENVIRONMENT_TYPE', 'local');

// ======================
// Authentication Keys and Salts
// ======================
${auth_keys}

// ======================
// Table Prefix
// ======================
\$table_prefix = '${TABLE_PREFIX}';

${preserved_constants}// ======================
// DDEV Database Configuration
// ======================
\$ddev_settings = dirname(__FILE__) . '/wp-config-ddev.php';
if (is_readable(\$ddev_settings) && !defined('DB_USER')) {
    require_once(\$ddev_settings);
}

// ======================
// Bootstrap WordPress
// ======================
if (!defined('ABSPATH')) {
    define('ABSPATH', __DIR__ . '/');
}
require_once ABSPATH . 'wp-settings.php';
WPCONFIG

    print_success "Custom wp-config.php created"
}

# =============================================================================
# Phase 3: DDEV & Database
# =============================================================================

start_ddev() {
    print_info "Starting DDEV..."

    if ! ddev start; then
        print_error "DDEV failed to start"
        exit 1
    fi

    print_success "DDEV started"
}

import_database() {
    print_info "Importing database..."

    if ! ddev import-db --file=wp-content/mysql.sql; then
        print_error "Database import failed"
        exit 1
    fi

    # Delete the SQL file after successful import
    rm wp-content/mysql.sql

    print_success "Database imported"
}

update_urls() {
    print_info "Updating site URLs..."

    # Get old URL directly from database (not WP-CLI, as wp-config-ddev.php overrides it)
    local old_url
    old_url=$(ddev mysql -N -e "SELECT option_value FROM ${TABLE_PREFIX}options WHERE option_name = 'siteurl' LIMIT 1")

    if [[ -z "$old_url" ]]; then
        print_error "Could not extract old site URL from database"
        exit 1
    fi

    local new_url="https://${PROJECT_NAME}.ddev.site"

    # Check if URLs are already the same (shouldn't happen, but just in case)
    if [[ "$old_url" == "$new_url" ]]; then
        print_info "URLs already match, skipping search-replace"
        print_success "URLs OK"
        return
    fi

    print_info "Old URL: $old_url"
    print_info "New URL: $new_url"

    # Search-replace throughout database
    # (WP_HOME and WP_SITEURL are set by wp-config-ddev.php, so we don't need to update those options)
    print_info "Running search-replace..."
    ddev wp search-replace "$old_url" "$new_url" --all-tables --precise --skip-columns=guid

    print_success "URLs updated"
}

# =============================================================================
# Phase 4: Admin Account Management (Optional)
# =============================================================================

create_default_admin() {
    if [[ "$CREATE_DEFAULT_ADMIN" != true ]]; then
        return
    fi

    echo ""
    print_info "Creating admin account for local testing..."

    # Check if 'admin' user already exists
    if ddev wp user get admin --field=ID &>/dev/null; then
        print_warning "User 'admin' already exists, updating password instead"
        if ddev wp user update admin --user_pass="password" --skip-themes --skip-plugins &>/dev/null; then
            print_success "Password updated for existing 'admin' user"
        else
            print_error "Failed to update password for 'admin' user"
        fi
    else
        # Create new admin user
        if ddev wp user create admin admin@example.com --role=administrator --user_pass="password" --skip-themes --skip-plugins &>/dev/null; then
            print_success "Created admin account (username: admin, password: password)"
        else
            print_error "Failed to create admin account"
        fi
    fi
}

reset_admin_password() {
    if [[ "$RESET_PASSWORD" != true ]]; then
        return
    fi

    echo ""
    print_info "Admin Password Reset"
    echo ""

    # List admin users
    echo "Available admin users:"
    ddev wp user list --role=administrator --format=table --skip-themes --skip-plugins
    echo ""

    # Get username (loop until valid)
    local username
    while true; do
        read -r -p "Enter username to reset password for: " username

        # Verify user exists and is admin
        if ddev wp user get "$username" --field=roles --skip-themes --skip-plugins 2>/dev/null | grep -q "administrator"; then
            break
        fi

        print_error "User '$username' is not an administrator or doesn't exist. Please try again."
        echo ""
    done

    # Get new password (hidden input)
    local password
    local password_confirm

    while true; do
        read -rs -p "Enter new password: " password
        echo ""
        read -rs -p "Confirm new password: " password_confirm
        echo ""

        if [[ "$password" != "$password_confirm" ]]; then
            print_error "Passwords do not match"
            continue
        fi

        if [[ -z "$password" ]]; then
            print_error "Password cannot be empty"
            continue
        fi

        break
    done

    # Reset password
    if ddev wp user update "$username" --user_pass="$password"; then
        print_success "Password updated for user: $username"
    else
        print_error "Failed to update password"
    fi
}

# =============================================================================
# Phase 5: Completion
# =============================================================================

show_success_message() {
    local ddev_url="https://${PROJECT_NAME}.ddev.site"

    echo ""
    echo -e "${GREEN}============================================${NC}"
    echo -e "${GREEN}WP Engine import complete!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo ""
    echo "Project: $PROJECT_NAME"
    echo "URL: $ddev_url"
    echo "Location: $PROJECT_DIR"
    echo "Original wp-config.php saved as: wp-config-backup.php"
    echo ""

    # Show warning about auto-preserved unknown constants
    if [[ ${#UNKNOWN_CONSTANTS[@]} -gt 0 ]]; then
        print_warning "Unknown constants were auto-preserved in wp-config.php:"
        for const_name in "${UNKNOWN_CONSTANTS[@]}"; do
            echo "  - $const_name"
        done
        echo ""
        echo "Review these in wp-config.php and remove any that aren't needed."
        echo ""
    fi

    echo "The project is started and ready for use."
    echo ""

    if [[ "$ORIGINAL_DIR" != "$PROJECT_DIR" ]]; then
        # User is not in project directory - show cd instruction
        echo "To work in this project, run:"
        echo "  cd $PROJECT_DIR"
        echo ""
    else
        # User is already in project directory - show useful commands
        echo "Useful commands:"
        echo "  ddev start          - Start the project"
        echo "  ddev stop           - Stop the project"
        echo "  ddev wp             - Run WP-CLI commands"
        echo "  ddev launch         - Open site in browser"
        echo "  ddev describe       - Show project details"
        echo ""
    fi
}

# =============================================================================
# Main
# =============================================================================

main() {
    # Save original directory to show cd instructions later
    ORIGINAL_DIR="$(pwd)"

    echo ""
    echo "========================================"
    echo "  DDEV WP Engine Import"
    echo "========================================"

    # Phase 1: Input Collection & Validation
    check_prerequisites
    get_backup_path
    get_project_directory
    get_project_name
    get_admin_options
    show_confirmation

    # Phase 2: Project Setup
    prepare_directory
    extract_backup
    cleanup_wpe_files
    analyze_wp_config
    configure_ddev
    create_wp_config

    # Phase 3: DDEV & Database
    start_ddev
    import_database
    update_urls

    # Phase 4: Admin Account Management (Optional)
    create_default_admin
    reset_admin_password

    # Phase 5: Completion
    show_success_message
}

# Run main function
main "$@"
